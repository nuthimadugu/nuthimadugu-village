<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¾ Nuthimadugu Village Portal</title>
    <meta name="description" content="Nuthimadugu Village Portal - Kambadur Mandal, Anantapuramu District, Andhra Pradesh">
    <meta name="theme-color" content="#2e7d32">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ¾</text></svg>">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --secondary: #ff8f00;
            --accent: #e65100;
            --danger: #dc3545;
            --success: #28a745;
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #333;
            --text-light: #666;
            --border: #e0e0e0;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; }
        
        /* Header */
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; padding: 12px 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .header h1 { font-size: 1.3em; display: flex; align-items: center; gap: 8px; }
        .header-info { font-size: 0.75em; opacity: 0.9; }
        .header-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        
        /* Buttons */
        .btn { padding: 8px 14px; border: none; border-radius: 20px; cursor: pointer; font-size: 0.85em; font-weight: 500; transition: all 0.3s; display: inline-flex; align-items: center; gap: 5px; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-light { background: rgba(255,255,255,0.2); color: white; }
        .btn-light:hover { background: rgba(255,255,255,0.3); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-full { width: 100%; justify-content: center; }
        
        /* User Badge */
        .user-badge { background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; font-size: 0.8em; display: flex; align-items: center; gap: 6px; }
        .user-avatar { width: 26px; height: 26px; background: white; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.85em; }
        .admin-badge { background: var(--danger); padding: 2px 6px; border-radius: 8px; font-size: 0.6em; }
        .blocked-badge { background: #c62828; padding: 2px 6px; border-radius: 8px; font-size: 0.6em; }
        
        /* Ticker */
        .ticker { background: var(--accent); color: white; padding: 6px 0; overflow: hidden; font-size: 0.85em; }
        .ticker-content { display: flex; animation: ticker 35s linear infinite; white-space: nowrap; }
        .ticker-item { padding: 0 30px; display: flex; align-items: center; gap: 6px; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .live-dot { width: 8px; height: 8px; background: #ff5252; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        /* Navigation */
        .nav { background: white; padding: 8px; display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; border-bottom: 1px solid var(--border); position: sticky; top: 52px; z-index: 99; }
        .nav-btn { padding: 8px 12px; border: none; background: var(--bg); border-radius: 18px; cursor: pointer; font-size: 0.8em; font-weight: 500; transition: all 0.3s; }
        .nav-btn:hover, .nav-btn.active { background: var(--primary); color: white; }
        
        /* Main Content */
        .main { max-width: 1200px; margin: 0 auto; padding: 15px; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Cards */
        .card { background: var(--card); border-radius: 12px; padding: 18px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .card h3 { color: var(--primary); margin-bottom: 12px; font-size: 1em; display: flex; align-items: center; gap: 8px; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .stat-card { background: var(--card); border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .stat-icon { font-size: 1.6em; margin-bottom: 5px; }
        .stat-value { font-size: 1.3em; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 0.75em; color: var(--text-light); }
        
        /* Funds */
        .funds-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .fund-card { padding: 15px; border-radius: 12px; text-align: center; color: white; }
        .fund-card.collected { background: linear-gradient(135deg, #4caf50, #8bc34a); }
        .fund-card.spent { background: linear-gradient(135deg, #ff9800, #ffc107); }
        .fund-card.balance { background: linear-gradient(135deg, #2196f3, #03a9f4); }
        .fund-card .amount { font-size: 1.4em; font-weight: bold; }
        .fund-card .label { font-size: 0.8em; opacity: 0.9; }
        
        .fund-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--primary); }
        .fund-item.expense { border-left-color: var(--secondary); }
        .fund-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1em; }
        .fund-icon.in { background: #c8e6c9; }
        .fund-icon.out { background: #fff3e0; }
        .fund-details { flex: 1; }
        .fund-details h4 { font-size: 0.85em; margin-bottom: 2px; }
        .fund-details p { font-size: 0.7em; color: var(--text-light); }
        .fund-amount { font-weight: bold; font-size: 0.9em; }
        .fund-amount.in { color: var(--primary); }
        .fund-amount.out { color: var(--secondary); }
        
        .purpose-tag { display: inline-block; padding: 1px 5px; border-radius: 8px; font-size: 0.65em; font-weight: 500; margin-left: 4px; }
        .purpose-development { background: #e3f2fd; color: #1976d2; }
        .purpose-festival { background: #fce4ec; color: #c2185b; }
        .purpose-temple { background: #fff8e1; color: #ff8f00; }
        
        /* Institutions */
        .inst-list { display: grid; gap: 8px; }
        .inst-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg); border-radius: 8px; }
        .inst-icon { width: 40px; height: 40px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; }
        .inst-info { flex: 1; }
        .inst-info h4 { font-size: 0.85em; margin-bottom: 2px; }
        .inst-info p { font-size: 0.75em; color: var(--text-light); }
        .inst-status { padding: 2px 6px; border-radius: 10px; font-size: 0.65em; font-weight: bold; background: #c8e6c9; color: #2e7d32; }
        
        /* Updates */
        .update-item { border-left: 3px solid var(--secondary); padding: 10px; margin-bottom: 8px; background: var(--bg); border-radius: 0 8px 8px 0; }
        .update-item.urgent { border-left-color: #f44336; background: #ffebee; }
        .update-item.important { border-left-color: #ff9800; background: #fff3e0; }
        .update-time { font-size: 0.7em; color: var(--secondary); font-weight: bold; margin-bottom: 3px; }
        .update-title { font-weight: bold; font-size: 0.9em; margin-bottom: 3px; }
        .priority-badge { display: inline-block; padding: 1px 5px; border-radius: 6px; font-size: 0.6em; font-weight: bold; margin-left: 5px; color: white; }
        .priority-badge.urgent { background: #f44336; }
        .priority-badge.important { background: #ff9800; }
        
        /* Jobs */
        .job-item { background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 3px solid var(--primary); }
        .job-item h4 { color: var(--primary); margin-bottom: 5px; font-size: 0.9em; }
        .job-meta { display: flex; flex-wrap: wrap; gap: 10px; margin: 6px 0; font-size: 0.75em; color: var(--text-light); }
        .job-actions { margin-top: 8px; }
        
        /* Chat */
        .chat-container { background: var(--card); border-radius: 12px; overflow: hidden; height: 450px; display: flex; flex-direction: column; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .chat-header { background: var(--primary); color: white; padding: 10px 12px; font-size: 0.9em; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; background: #fafafa; }
        .message { display: flex; gap: 8px; margin-bottom: 10px; }
        .message.own { flex-direction: row-reverse; }
        .msg-avatar { width: 30px; height: 30px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8em; flex-shrink: 0; }
        .message.own .msg-avatar { background: var(--secondary); }
        .msg-content { max-width: 70%; }
        .msg-sender { font-size: 0.65em; color: var(--text-light); margin-bottom: 2px; }
        .message.own .msg-sender { text-align: right; }
        .msg-bubble { padding: 8px 10px; border-radius: 10px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.08); font-size: 0.85em; }
        .message.own .msg-bubble { background: var(--primary); color: white; }
        .msg-time { font-size: 0.6em; color: var(--text-light); margin-top: 2px; }
        .message.own .msg-time { text-align: right; }
        .chat-input-area { padding: 10px; background: white; border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .chat-input { flex: 1; padding: 10px 12px; border: 1px solid var(--border); border-radius: 20px; outline: none; font-size: 0.85em; }
        .chat-input:focus { border-color: var(--primary); }
        .send-btn { width: 38px; height: 38px; border: none; background: var(--primary); color: white; border-radius: 50%; cursor: pointer; font-size: 1em; }
        .chat-prompt { padding: 15px; text-align: center; background: #fff3e0; font-size: 0.9em; }
        .chat-blocked { padding: 15px; text-align: center; background: #ffebee; color: #c62828; font-size: 0.9em; }
        
        /* Events */
        .event-item { display: flex; gap: 10px; padding: 10px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; }
        .event-date { background: var(--primary); color: white; padding: 8px; border-radius: 8px; text-align: center; min-width: 50px; }
        .event-date .day { font-size: 1.1em; font-weight: bold; }
        .event-date .month { font-size: 0.65em; text-transform: uppercase; }
        .event-details h4 { font-size: 0.85em; margin-bottom: 2px; }
        .event-details p { font-size: 0.75em; color: var(--text-light); }
        
        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 12px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 14px; max-width: 420px; width: 100%; max-height: 90vh; overflow: hidden; }
        .modal-header { padding: 20px; text-align: center; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; position: relative; }
        .modal-header.admin { background: linear-gradient(135deg, #333, #555); }
        .modal-header .close { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 1em; }
        .modal-header .icon { font-size: 2em; margin-bottom: 6px; }
        .modal-header h2 { font-size: 1.2em; margin-bottom: 3px; }
        .modal-header p { opacity: 0.9; font-size: 0.8em; }
        .modal-body { padding: 18px; max-height: 55vh; overflow-y: auto; }
        .modal-tabs { display: flex; background: var(--bg); }
        .modal-tab { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; font-weight: 500; font-size: 0.85em; border-bottom: 3px solid transparent; }
        .modal-tab.active { background: white; border-bottom-color: var(--primary); color: var(--primary); }
        
        /* Forms */
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.85em; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 0.9em; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .msg-box { padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center; font-size: 0.85em; display: none; }
        .msg-box.error { background: #ffebee; color: #c62828; }
        .msg-box.success { background: #e8f5e9; color: #2e7d32; }
        .msg-box.active { display: block; }
        
        .link-btn { color: var(--primary); cursor: pointer; font-size: 0.8em; text-decoration: underline; background: none; border: none; }
        .security-hint { font-size: 0.7em; color: var(--text-light); margin-top: 3px; }
        
        /* Admin Dashboard */
        .admin-modal .modal-content { max-width: 850px; }
        .admin-tabs { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 12px; background: var(--bg); padding: 6px; border-radius: 8px; }
        .admin-tab { padding: 7px 12px; border: none; background: white; border-radius: 6px; cursor: pointer; font-size: 0.75em; font-weight: 500; }
        .admin-tab.active { background: var(--primary); color: white; }
        .admin-panel { display: none; }
        .admin-panel.active { display: block; }
        .admin-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 8px; margin-bottom: 12px; }
        .admin-stat { background: var(--bg); padding: 10px; border-radius: 8px; text-align: center; }
        .admin-stat .num { font-size: 1.4em; font-weight: bold; color: var(--primary); }
        .admin-stat .lbl { font-size: 0.7em; color: var(--text-light); }
        
        .edit-form { background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .edit-form h4 { color: var(--primary); margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid var(--border); font-size: 0.9em; }
        
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; font-size: 0.75em; }
        .data-table th, .data-table td { padding: 8px; text-align: left; border-bottom: 1px solid var(--border); }
        .data-table th { background: var(--primary); color: white; font-size: 0.8em; }
        .data-table tr:hover { background: var(--bg); }
        .action-btn { padding: 3px 6px; font-size: 0.7em; border: none; border-radius: 4px; cursor: pointer; margin: 1px; }
        .action-delete { background: #ffebee; color: #c62828; }
        .action-block { background: #ffebee; color: #c62828; }
        .action-unblock { background: #e8f5e9; color: #2e7d32; }
        
        .user-status { padding: 2px 5px; border-radius: 6px; font-size: 0.65em; font-weight: bold; }
        .user-status.active { background: #c8e6c9; color: #2e7d32; }
        .user-status.blocked { background: #ffcdd2; color: #c62828; }
        
        /* Footer */
        .footer { background: #333; color: white; text-align: center; padding: 18px; margin-top: 25px; }
        .footer p { font-size: 0.8em; opacity: 0.8; margin: 2px 0; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.1em; }
            .header-content { justify-content: center; text-align: center; }
            .nav { top: auto; position: relative; }
            .nav-btn { padding: 6px 10px; font-size: 0.7em; }
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .funds-summary { grid-template-columns: 1fr; }
            .modal-content { margin: 8px; }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <div>
                <h1>ğŸŒ¾ Nuthimadugu Village</h1>
                <div class="header-info">Kambadur Mandal, Anantapuramu â€¢ PIN: 515787</div>
            </div>
            <div class="header-actions">
                <div id="userBadge" style="display: none;" class="user-badge">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">User</span>
                    <span id="adminBadge" class="admin-badge" style="display: none;">ADMIN</span>
                    <span id="blockedBadge" class="blocked-badge" style="display: none;">BLOCKED</span>
                    <button class="btn btn-light" onclick="logout()" style="padding: 3px 8px; font-size: 0.75em;">Logout</button>
                </div>
                <button id="loginBtn" class="btn btn-light" onclick="openAuthModal()">ğŸ” Login</button>
                <button id="adminLoginBtn" class="btn btn-secondary" onclick="openAdminLogin()">âš™ï¸ Admin</button>
            </div>
        </div>
    </header>

    <!-- TICKER -->
    <div class="ticker">
        <div class="ticker-content">
            <span class="ticker-item"><span class="live-dot"></span> Weekly Market Every Monday!</span>
            <span class="ticker-item">ğŸ¦ AP Grameena Bank - Nuthimadugu Branch</span>
            <span class="ticker-item"><span class="live-dot"></span> Weekly Market Every Monday!</span>
            <span class="ticker-item">ğŸ¦ AP Grameena Bank - Nuthimadugu Branch</span>
        </div>
    </div>

    <!-- NAVIGATION -->
    <nav class="nav">
        <button class="nav-btn active" data-section="home">ğŸ  Home</button>
        <button class="nav-btn" data-section="funds">ğŸ’° Funds</button>
        <button class="nav-btn" data-section="institutions">ğŸ›ï¸ Institutions</button>
        <button class="nav-btn" data-section="updates">ğŸ“° Updates</button>
        <button class="nav-btn" data-section="employment">ğŸ’¼ Jobs</button>
        <button class="nav-btn" data-section="chat">ğŸ’¬ Chat</button>
        <button class="nav-btn" data-section="events">ğŸ“… Events</button>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main">
        <!-- HOME SECTION -->
        <section id="home" class="section active">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-icon">ğŸ‘¥</div><div class="stat-value">~2,500</div><div class="stat-label">Population</div></div>
                <div class="stat-card"><div class="stat-icon">ğŸ </div><div class="stat-value">~520</div><div class="stat-label">Households</div></div>
                <div class="stat-card"><div class="stat-icon">ğŸ’°</div><div class="stat-value" id="homeFundBalance">â‚¹0</div><div class="stat-label">Village Fund</div></div>
                <div class="stat-card"><div class="stat-icon">ğŸ‘¤</div><div class="stat-value" id="homeUserCount">0</div><div class="stat-label">Members</div></div>
            </div>
            <div class="card">
                <h3>ğŸ“ About Our Village</h3>
                <p style="font-size: 0.9em;"><strong>Nuthimadugu</strong> is a village in <strong>Kambadur Mandal</strong>, Anantapuramu District, Andhra Pradesh, India.</p>
                <p style="margin-top: 6px; font-size: 0.85em;"><strong>Weekly Market:</strong> Every Monday | <strong>Main Crops:</strong> Groundnut, Paddy, Millets</p>
            </div>
            <div class="card">
                <h3>ğŸ”” Quick Access</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); gap: 6px;">
                    <button class="btn btn-primary btn-full" onclick="showSection('funds')">ğŸ’° Funds</button>
                    <button class="btn btn-primary btn-full" onclick="showSection('institutions')">ğŸ›ï¸ Services</button>
                    <button class="btn btn-primary btn-full" onclick="showSection('updates')">ğŸ“° News</button>
                    <button class="btn btn-primary btn-full" onclick="showSection('employment')">ğŸ’¼ Jobs</button>
                    <button class="btn btn-primary btn-full" onclick="showSection('chat')">ğŸ’¬ Chat</button>
                    <button class="btn btn-primary btn-full" onclick="showSection('events')">ğŸ“… Events</button>
                </div>
            </div>
        </section>

        <!-- FUNDS SECTION -->
        <section id="funds" class="section">
            <div class="card"><h3>ğŸ’° Village Fund Transparency</h3></div>
            <div class="funds-summary">
                <div class="fund-card collected"><div class="amount" id="totalCollected">â‚¹0</div><div class="label">Collected</div></div>
                <div class="fund-card spent"><div class="amount" id="totalSpent">â‚¹0</div><div class="label">Spent</div></div>
                <div class="fund-card balance"><div class="amount" id="fundBalance">â‚¹0</div><div class="label">Balance</div></div>
            </div>
            <div class="card"><h3>ğŸ“¥ Collections</h3><div id="collectionsList"><p style="color: var(--text-light); font-size: 0.85em;">No collections yet</p></div></div>
            <div class="card"><h3>ğŸ“¤ Expenses</h3><div id="expensesList"><p style="color: var(--text-light); font-size: 0.85em;">No expenses yet</p></div></div>
        </section>

        <!-- INSTITUTIONS SECTION -->
        <section id="institutions" class="section">
            <div class="card"><h3>ğŸ›ï¸ Government & Services</h3></div>
            <div class="inst-list" id="institutionsList"></div>
        </section>

        <!-- UPDATES SECTION -->
        <section id="updates" class="section">
            <div class="card"><h3>ğŸ“° Village Announcements</h3></div>
            <div id="updatesList"><p style="color: var(--text-light); font-size: 0.85em;">No announcements yet</p></div>
        </section>

        <!-- EMPLOYMENT SECTION -->
        <section id="employment" class="section">
            <div class="card">
                <h3>ğŸ’¼ AP Employment Notices</h3>
                <p style="color: var(--text-light); font-size: 0.8em;">Latest government job notifications in Andhra Pradesh</p>
            </div>
            <div id="jobsList"><p style="color: var(--text-light); font-size: 0.85em;">No job notices available</p></div>
        </section>

        <!-- CHAT SECTION -->
        <section id="chat" class="section">
            <div class="card"><h3>ğŸ’¬ Village Community Chat</h3></div>
            <div class="chat-container">
                <div class="chat-header">ğŸ’¬ Community Chat</div>
                <div class="chat-messages" id="chatMessages"></div>
                <div id="chatPrompt" class="chat-prompt">
                    <p style="margin-bottom: 10px;">ğŸ” Please login to participate in chat</p>
                    <button class="btn btn-primary" onclick="openAuthModal()">Login / Register</button>
                </div>
                <div id="chatBlocked" class="chat-blocked" style="display: none;">
                    <p>ğŸš« Your account has been blocked. Contact Sarpanch for help.</p>
                </div>
                <div id="chatInputArea" class="chat-input-area" style="display: none;">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter')sendMessage()">
                    <button class="send-btn" onclick="sendMessage()">â¤</button>
                </div>
            </div>
        </section>

        <!-- EVENTS SECTION -->
        <section id="events" class="section">
            <div class="card"><h3>ğŸ“… Upcoming Events</h3></div>
            <div id="eventsList"><p style="color: var(--text-light); font-size: 0.85em;">No upcoming events</p></div>
            <div class="card" style="margin-top: 12px;">
                <h3>ğŸ—“ï¸ Weekly Schedule</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 6px; margin-top: 10px;">
                    <div style="padding: 8px; background: #e8f5e9; border-radius: 8px; text-align: center; border: 2px solid var(--primary); font-size: 0.8em;"><strong>Monday</strong><br>ğŸ“… Market</div>
                    <div style="padding: 8px; background: var(--bg); border-radius: 8px; text-align: center; font-size: 0.8em;"><strong>Tuesday</strong><br>Ration</div>
                    <div style="padding: 8px; background: var(--bg); border-radius: 8px; text-align: center; font-size: 0.8em;"><strong>Saturday</strong><br>Panchayat</div>
                </div>
            </div>
        </section>
    </main>

    <!-- AUTH MODAL -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close" onclick="closeModal('authModal')">Ã—</button>
                <div class="icon">ğŸŒ¾</div>
                <h2>Nuthimadugu Portal</h2>
                <p>Connect with your village</p>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchAuthTab('login')">ğŸ” Login</button>
                <button class="modal-tab" onclick="switchAuthTab('register')">ğŸ“ Register</button>
            </div>
            <div class="modal-body">
                <!-- LOGIN PANEL -->
                <div id="loginPanel" class="auth-panel active">
                    <div class="msg-box error" id="loginError"></div>
                    <div class="form-group">
                        <label>ğŸ“§ Email Address</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>ğŸ”‘ Password</label>
                        <input type="password" id="loginPassword" placeholder="Your password">
                    </div>
                    <button class="btn btn-primary btn-full" onclick="userLogin()">ğŸš€ Login</button>
                    <p style="text-align: center; margin-top: 10px;">
                        <button class="link-btn" onclick="switchAuthTab('forgot')">Forgot Password?</button>
                    </p>
                </div>
                
                <!-- REGISTER PANEL -->
                <div id="registerPanel" class="auth-panel" style="display: none;">
                    <div class="msg-box error" id="registerError"></div>
                    <div class="msg-box success" id="registerSuccess"></div>
                    <div class="form-group"><label>ğŸ‘¤ Full Name *</label><input type="text" id="regName" placeholder="Your full name"></div>
                    <div class="form-group"><label>ğŸ“§ Email Address *</label><input type="email" id="regEmail" placeholder="your@email.com"></div>
                    <div class="form-group"><label>ğŸ“± Mobile Number *</label><input type="tel" id="regMobile" maxlength="10" placeholder="10-digit mobile"></div>
                    <div class="form-group"><label>ğŸ”‘ Password *</label><input type="password" id="regPassword" placeholder="Min 4 characters"></div>
                    <div class="form-group"><label>ğŸ” Confirm Password *</label><input type="password" id="regConfirmPassword" placeholder="Confirm password"></div>
                    <hr style="margin: 12px 0; border: none; border-top: 1px solid var(--border);">
                    <p style="font-size: 0.8em; color: var(--text-light); margin-bottom: 10px;">ğŸ”’ Security Question (for password recovery)</p>
                    <div class="form-group">
                        <label>Security Question *</label>
                        <select id="regSecurityQuestion">
                            <option value="">-- Select a question --</option>
                            <option value="pet">What is your pet's name?</option>
                            <option value="school">What is your first school name?</option>
                            <option value="city">In which city were you born?</option>
                            <option value="friend">What is your best friend's name?</option>
                            <option value="mother">What is your mother's maiden name?</option>
                            <option value="favorite">What is your favorite movie?</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Security Answer *</label>
                        <input type="text" id="regSecurityAnswer" placeholder="Your answer">
                        <p class="security-hint">âš ï¸ Remember this answer to reset your password</p>
                    </div>
                    <button class="btn btn-primary btn-full" onclick="registerUser()">ğŸ“ Create Account</button>
                </div>
                
                <!-- FORGOT PASSWORD PANEL -->
                <div id="forgotPanel" class="auth-panel" style="display: none;">
                    <div class="msg-box error" id="forgotError"></div>
                    <div class="msg-box success" id="forgotSuccess"></div>
                    <div id="forgotStep1">
                        <p style="margin-bottom: 10px; font-size: 0.85em; color: var(--text-light);">Enter your email to verify</p>
                        <div class="form-group"><label>ğŸ“§ Email Address</label><input type="email" id="forgotEmail" placeholder="your@email.com"></div>
                        <button class="btn btn-primary btn-full" onclick="verifyEmail()">Next â†’</button>
                    </div>
                    <div id="forgotStep2" style="display: none;">
                        <p style="margin-bottom: 10px; font-size: 0.85em; color: var(--text-light);">Answer your security question</p>
                        <div class="form-group"><label>ğŸ”’ Security Question</label><p id="displaySecurityQuestion" style="padding: 8px; background: var(--bg); border-radius: 6px; font-size: 0.9em; font-weight: 500;"></p></div>
                        <div class="form-group"><label>Your Answer *</label><input type="text" id="forgotSecurityAnswer" placeholder="Your answer"></div>
                        <button class="btn btn-primary btn-full" onclick="verifySecurityAnswer()">Verify â†’</button>
                    </div>
                    <div id="forgotStep3" style="display: none;">
                        <p style="margin-bottom: 10px; font-size: 0.85em; color: var(--success);">âœ… Verified! Set new password</p>
                        <div class="form-group"><label>ğŸ”‘ New Password</label><input type="password" id="newPassword" placeholder="Min 4 characters"></div>
                        <div class="form-group"><label>ğŸ” Confirm Password</label><input type="password" id="confirmNewPassword" placeholder="Confirm password"></div>
                        <button class="btn btn-success btn-full" onclick="resetPassword()">ğŸ’¾ Reset Password</button>
                    </div>
                    <p style="text-align: center; margin-top: 10px;"><button class="link-btn" onclick="switchAuthTab('login')">â† Back to Login</button></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN LOGIN MODAL -->
    <div class="modal" id="adminLoginModal">
        <div class="modal-content">
            <div class="modal-header admin">
                <button class="close" onclick="closeModal('adminLoginModal')">Ã—</button>
                <div class="icon">âš™ï¸</div>
                <h2>Admin Portal</h2>
                <p>Village Management System</p>
            </div>
            <div class="modal-body">
                <div class="msg-box error" id="adminLoginError"></div>
                <div class="form-group"><label>ğŸ”‘ Admin Password</label><input type="password" id="adminPassword" placeholder="Enter admin password" onkeypress="if(event.key==='Enter')adminLogin()"></div>
                <button class="btn btn-primary btn-full" onclick="adminLogin()">ğŸš€ Admin Login</button>
                <div style="margin-top: 10px; padding: 8px; background: var(--bg); border-radius: 6px; text-align: center; font-size: 0.8em;">
                    <strong>Password:</strong> <code style="background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px;">Farmer@515001</code>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD MODAL -->
    <div class="modal admin-modal" id="adminDashboardModal">
        <div class="modal-content" style="max-width: 850px;">
            <div class="modal-header admin">
                <button class="close" onclick="closeModal('adminDashboardModal')">Ã—</button>
                <div class="icon">âš™ï¸</div>
                <h2>Admin Dashboard</h2>
                <p>Manage Village Portal</p>
            </div>
            <div class="modal-body" style="max-height: 65vh;">
                <div class="admin-stats">
                    <div class="admin-stat"><div class="num" id="statUsers">0</div><div class="lbl">Users</div></div>
                    <div class="admin-stat"><div class="num" id="statBlocked">0</div><div class="lbl">Blocked</div></div>
                    <div class="admin-stat"><div class="num" id="statUpdates">0</div><div class="lbl">Updates</div></div>
                    <div class="admin-stat"><div class="num" id="statFunds">â‚¹0</div><div class="lbl">Balance</div></div>
                </div>
                
                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="showAdminPanel('panelUsers')">ğŸ‘¥ Users</button>
                    <button class="admin-tab" onclick="showAdminPanel('panelAnnouncements')">ğŸ“° Announcements</button>
                    <button class="admin-tab" onclick="showAdminPanel('panelFunds')">ğŸ’° Funds</button>
                    <button class="admin-tab" onclick="showAdminPanel('panelEvents')">ğŸ“… Events</button>
                    <button class="admin-tab" onclick="showAdminPanel('panelJobs')">ğŸ’¼ Jobs</button>
                </div>

                <!-- USERS PANEL -->
                <div id="panelUsers" class="admin-panel active">
                    <h4 style="font-size: 0.9em; margin-bottom: 8px;">ğŸ‘¥ Registered Users</h4>
                    <p style="margin-bottom: 10px; font-size: 0.75em; color: var(--text-light);">Block/Unblock users</p>
                    <div style="overflow-x: auto;"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Mobile</th><th>Status</th><th>Actions</th></tr></thead><tbody id="usersTableBody"><tr><td colspan="5" style="text-align:center;">No users</td></tr></tbody></table></div>
                </div>

                <!-- ANNOUNCEMENTS PANEL -->
                <div id="panelAnnouncements" class="admin-panel">
                    <div class="edit-form">
                        <h4>ğŸ“ Post Announcement</h4>
                        <div class="form-group"><label>Title *</label><input type="text" id="annTitle" placeholder="Title"></div>
                        <div class="form-group"><label>Details *</label><textarea id="annDetails" rows="2" placeholder="Details"></textarea></div>
                        <div class="form-group"><label>Priority</label><select id="annPriority"><option value="normal">Normal</option><option value="important">Important</option><option value="urgent">Urgent</option></select></div>
                        <button class="btn btn-primary" onclick="postAnnouncement()">ğŸ“¤ Post</button>
                    </div>
                    <div style="overflow-x: auto;"><table class="data-table"><thead><tr><th>Title</th><th>Priority</th><th>Date</th><th>Actions</th></tr></thead><tbody id="annTableBody"></tbody></table></div>
                </div>

                <!-- FUNDS PANEL -->
                <div id="panelFunds" class="admin-panel">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px;">
                        <div class="edit-form">
                            <h4>ğŸ“¥ Add Collection</h4>
                            <div class="form-group"><label>Donor *</label><input type="text" id="colName" placeholder="Name"></div>
                            <div class="form-group"><label>Amount (â‚¹) *</label><input type="number" id="colAmount" placeholder="Amount"></div>
                            <div class="form-group"><label>Purpose</label><select id="colPurpose"><option value="development">Development</option><option value="festival">Festival</option><option value="temple">Temple</option></select></div>
                            <button class="btn btn-success" onclick="addCollection()">â• Add</button>
                        </div>
                        <div class="edit-form">
                            <h4>ğŸ“¤ Add Expense</h4>
                            <div class="form-group"><label>Description *</label><input type="text" id="expDesc" placeholder="Description"></div>
                            <div class="form-group"><label>Amount (â‚¹) *</label><input type="number" id="expAmount" placeholder="Amount"></div>
                            <div class="form-group"><label>Category</label><select id="expCategory"><option value="development">Development</option><option value="festival">Festival</option><option value="temple">Temple</option></select></div>
                            <button class="btn btn-secondary" onclick="addExpense()">â• Add</button>
                        </div>
                    </div>
                    <h4 style="font-size: 0.85em; margin: 12px 0 6px;">Collections</h4>
                    <div style="overflow-x: auto;"><table class="data-table"><thead><tr><th>Donor</th><th>Amount</th><th>Purpose</th><th>Actions</th></tr></thead><tbody id="colTableBody"></tbody></table></div>
                    <h4 style="font-size: 0.85em; margin: 12px 0 6px;">Expenses</h4>
                    <div style="overflow-x: auto;"><table class="data-table"><thead><tr><th>Description</th><th>Amount</th><th>Category</th><th>Actions</th></tr></thead><tbody id="expTableBody"></tbody></table></div>
                </div>

                <!-- EVENTS PANEL -->
                <div id="panelEvents" class="admin-panel">
                    <div class="edit-form">
                        <h4>ğŸ“… Add Event</h4>
                        <div class="form-row">
                            <div class="form-group"><label>Title *</label><input type="text" id="evtTitle" placeholder="Title"></div>
                            <div class="form-group"><label>Date *</label><input type="date" id="evtDate"></div>
                        </div>
                        <div class="form-group"><label>Location</label><input type="text" id="evtLocation" placeholder="Location"></div>
                        <button class="btn btn-primary" onclick="addEvent()">ğŸ“… Add</button>
                    </div>
                    <div style="overflow-x: auto;"><table class="data-table"><thead><tr><th>Event</th><th>Date</th><th>Location</th><th>Actions</th></tr></thead><tbody id="evtTableBody"></tbody></table></div>
                </div>

                <!-- JOBS PANEL -->
                <div id="panelJobs" class="admin-panel">
                    <div class="edit-form">
                        <h4>ğŸ’¼ Add Job Notice</h4>
                        <div class="form-group"><label>Job Title *</label><input type="text" id="jobTitle" placeholder="Title"></div>
                        <div class="form-group"><label>Organization *</label><input type="text" id="jobOrg" placeholder="Organization"></div>
                        <div class="form-row">
                            <div class="form-group"><label>Vacancies</label><input type="number" id="jobVacancies" placeholder="Number"></div>
                            <div class="form-group"><label>Last Date *</label><input type="date" id="jobLastDate"></div>
                        </div>
                        <div class="form-group"><label>Application Link *</label><input type="url" id="jobLink" placeholder="https://..."></div>
                        <button class="btn btn-primary" onclick="addJob()">ğŸ’¼ Add</button>
                    </div>
                    <div style="overflow-x: auto;"><table class="data-table"><thead><tr><th>Title</th><th>Organization</th><th>Last Date</th><th>Actions</th></tr></thead><tbody id="jobTableBody"></tbody></table></div>
                </div>

                <div style="margin-top: 15px; text-align: center;">
                    <button class="btn btn-danger" onclick="adminLogout()">ğŸ”’ Logout Admin</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <p>ğŸŒ¾ <strong>Nuthimadugu Village Portal</strong></p>
        <p>Kambadur Mandal, Anantapuramu District, AP - 515787</p>
        <p style="margin-top: 6px; font-size: 0.7em; opacity: 0.6;">Created by <strong>Girish Babu Kutagulla</strong></p>
    </footer>

    <!-- JAVASCRIPT -->
    <script>
        // ============================================
        // DATABASE (LocalStorage)
        // ============================================
        const DB = {
            get: (key) => JSON.parse(localStorage.getItem('ntm_' + key) || 'null'),
            set: (key, val) => localStorage.setItem('ntm_' + key, JSON.stringify(val)),
            init: function() {
                if (!this.get('users')) this.set('users', {});
                if (!this.get('collections')) this.set('collections', {});
                if (!this.get('expenses')) this.set('expenses', {});
                if (!this.get('updates')) this.set('updates', {});
                if (!this.get('events')) this.set('events', {});
                if (!this.get('jobs')) this.set('jobs', {
                    j1: { title: 'Grama Sachivalayam Jobs', org: 'AP Government', vacancies: 2000, lastDate: '2026-03-30', link: 'https://gramasachivalayam.ap.gov.in' },
                    j2: { title: 'Village Revenue Officer', org: 'AP Revenue Dept', vacancies: 150, lastDate: '2026-03-15', link: 'https://apssdc.in' },
                    j3: { title: 'ANM Health Worker', org: 'AP Health Dept', vacancies: 500, lastDate: '2026-04-10', link: 'https://cfw.ap.nic.in' }
                });
                if (!this.get('messages')) this.set('messages', {});
                if (!this.get('institutions')) this.set('institutions', {
                    i1: { name: 'Gram Panchayat Office', icon: 'ğŸ›ï¸', phone: '08559-245XXX', hours: 'Mon-Sat 10AM-5PM' },
                    i2: { name: 'Primary Health Center', icon: 'ğŸ¥', phone: '08559-245XXX', hours: '24x7 Emergency' },
                    i3: { name: 'ZP High School', icon: 'ğŸ«', phone: '08559-245XXX', hours: 'Mon-Sat 9AM-4PM' },
                    i4: { name: 'Andhra Pradesh Grameena Bank', icon: 'ğŸ¦', phone: '08559-245XXX', hours: 'Mon-Fri 10AM-4PM, Sat 10AM-1PM' },
                    i5: { name: 'Post Office', icon: 'ğŸ“®', phone: '08559-245XXX', hours: 'Mon-Sat 10AM-5PM' },
                    i6: { name: 'Ration Shop (Fair Price)', icon: 'ğŸª', phone: 'N/A', hours: 'Tuesday 9AM-2PM' }
                });
            }
        };

        const SECURITY_QUESTIONS = {
            pet: "What is your pet's name?",
            school: "What is your first school name?",
            city: "In which city were you born?",
            friend: "What is your best friend's name?",
            mother: "What is your mother's maiden name?",
            favorite: "What is your favorite movie?"
        };

        const PURPOSE_TAGS = {
            development: { label: 'Development', class: 'purpose-development' },
            festival: { label: 'Festival', class: 'purpose-festival' },
            temple: { label: 'Temple', class: 'purpose-temple' }
        };

        const ADMIN_PASSWORD = 'Farmer@515001';

        // ============================================
        // STATE
        // ============================================
        let currentUser = null;
        let isAdmin = false;
        let forgotUserData = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            DB.init();
            loadSession();
            setupNavigation();
            renderAll();
        }

        function loadSession() {
            const saved = DB.get('currentUser');
            const admin = localStorage.getItem('ntm_admin');
            if (saved) {
                const users = DB.get('users');
                if (users[saved.id]) {
                    currentUser = { ...users[saved.id], id: saved.id };
                }
            }
            isAdmin = admin === 'true';
            updateUI();
        }

        function updateUI() {
            const badge = document.getElementById('userBadge');
            const loginBtn = document.getElementById('loginBtn');
            
            if (currentUser) {
                badge.style.display = 'flex';
                loginBtn.style.display = 'none';
                document.getElementById('userName').textContent = currentUser.name || 'User';
                document.getElementById('userAvatar').textContent = (currentUser.name || 'U').charAt(0).toUpperCase();
                document.getElementById('adminBadge').style.display = isAdmin ? 'inline' : 'none';
                document.getElementById('blockedBadge').style.display = currentUser.blocked ? 'inline' : 'none';
                
                if (currentUser.blocked) {
                    document.getElementById('chatPrompt').style.display = 'none';
                    document.getElementById('chatBlocked').style.display = 'block';
                    document.getElementById('chatInputArea').style.display = 'none';
                } else {
                    document.getElementById('chatPrompt').style.display = 'none';
                    document.getElementById('chatBlocked').style.display = 'none';
                    document.getElementById('chatInputArea').style.display = 'flex';
                }
            } else {
                badge.style.display = 'none';
                loginBtn.style.display = 'inline-flex';
                document.getElementById('chatPrompt').style.display = 'block';
                document.getElementById('chatBlocked').style.display = 'none';
                document.getElementById('chatInputArea').style.display = 'none';
            }
        }

        function renderAll() {
            renderInstitutions();
            renderCollections();
            renderExpenses();
            renderUpdates();
            renderEvents();
            renderJobs();
            renderChat();
            updateFundSummary();
            updateStats();
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function setupNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => showSection(btn.dataset.section));
            });
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelector(`[data-section="${id}"]`).classList.add('active');
        }

        // ============================================
        // MODALS
        // ============================================
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', e => { if (e.target === m) closeModal(m.id); });
        });

        function showMsg(el, msg, type = 'error') { el.textContent = msg; el.className = 'msg-box ' + type + ' active'; }
        function hideMsg(el) { el.className = 'msg-box'; }
        function hideAllMsgs() { document.querySelectorAll('.msg-box').forEach(m => m.className = 'msg-box'); }

        // ============================================
        // AUTH FUNCTIONS
        // ============================================
        function openAuthModal() { openModal('authModal'); switchAuthTab('login'); }

        function switchAuthTab(tab) {
            hideAllMsgs();
            document.querySelectorAll('.modal-tab').forEach((t, i) => {
                t.classList.toggle('active', (tab === 'login' && i === 0) || (tab === 'register' && i === 1));
            });
            document.querySelectorAll('.auth-panel').forEach(p => p.style.display = 'none');
            document.getElementById(tab + 'Panel').style.display = 'block';
            if (tab === 'forgot') resetForgotSteps();
        }

        function resetForgotSteps() {
            document.getElementById('forgotStep1').style.display = 'block';
            document.getElementById('forgotStep2').style.display = 'none';
            document.getElementById('forgotStep3').style.display = 'none';
            forgotUserData = null;
        }

        function registerUser() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim().toLowerCase();
            const mobile = document.getElementById('regMobile').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regConfirmPassword').value;
            const secQ = document.getElementById('regSecurityQuestion').value;
            const secA = document.getElementById('regSecurityAnswer').value.trim().toLowerCase();
            
            const err = document.getElementById('registerError');
            const suc = document.getElementById('registerSuccess');
            hideMsg(err); hideMsg(suc);
            
            if (!name || !email || !mobile || !password || !confirm || !secQ || !secA) { showMsg(err, 'âŒ Fill all fields'); return; }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showMsg(err, 'âŒ Invalid email'); return; }
            if (mobile.length !== 10 || !/^\d+$/.test(mobile)) { showMsg(err, 'âŒ Invalid mobile'); return; }
            if (password.length < 4) { showMsg(err, 'âŒ Password min 4 chars'); return; }
            if (password !== confirm) { showMsg(err, 'âŒ Passwords mismatch'); return; }
            
            const users = DB.get('users');
            if (Object.values(users).find(u => u.email === email)) { showMsg(err, 'âŒ Email exists'); return; }
            
            const id = 'u' + Date.now();
            users[id] = { name, email, mobile, password, securityQuestion: secQ, securityAnswer: secA, blocked: false, createdAt: new Date().toISOString() };
            DB.set('users', users);
            
            ['regName', 'regEmail', 'regMobile', 'regPassword', 'regConfirmPassword', 'regSecurityQuestion', 'regSecurityAnswer'].forEach(i => document.getElementById(i).value = '');
            
            showMsg(suc, 'âœ… Account created! Please login.', 'success');
            updateStats();
            setTimeout(() => switchAuthTab('login'), 1500);
        }

        function userLogin() {
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const err = document.getElementById('loginError');
            hideMsg(err);
            
            if (!email || !password) { showMsg(err, 'âŒ Fill all fields'); return; }
            
            const users = DB.get('users');
            const id = Object.keys(users).find(k => users[k].email === email);
            
            if (!id) { showMsg(err, 'âŒ Email not found'); return; }
            if (users[id].blocked) { showMsg(err, 'ğŸš« Account blocked'); return; }
            if (users[id].password !== password) { showMsg(err, 'âŒ Wrong password'); return; }
            
            currentUser = { ...users[id], id };
            DB.set('currentUser', { id });
            closeModal('authModal');
            updateUI();
            renderChat();
        }

        function verifyEmail() {
            const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
            const err = document.getElementById('forgotError');
            hideMsg(err);
            
            if (!email) { showMsg(err, 'âŒ Enter email'); return; }
            
            const users = DB.get('users');
            const id = Object.keys(users).find(k => users[k].email === email);
            
            if (!id) { showMsg(err, 'âŒ Email not found'); return; }
            
            forgotUserData = { id, user: users[id] };
            document.getElementById('displaySecurityQuestion').textContent = SECURITY_QUESTIONS[forgotUserData.user.securityQuestion];
            document.getElementById('forgotStep1').style.display = 'none';
            document.getElementById('forgotStep2').style.display = 'block';
        }

        function verifySecurityAnswer() {
            const answer = document.getElementById('forgotSecurityAnswer').value.trim().toLowerCase();
            const err = document.getElementById('forgotError');
            hideMsg(err);
            
            if (!answer) { showMsg(err, 'âŒ Enter answer'); return; }
            if (answer !== forgotUserData.user.securityAnswer) { showMsg(err, 'âŒ Wrong answer'); return; }
            
            document.getElementById('forgotStep2').style.display = 'none';
            document.getElementById('forgotStep3').style.display = 'block';
        }

        function resetPassword() {
            const newP = document.getElementById('newPassword').value;
            const confP = document.getElementById('confirmNewPassword').value;
            const err = document.getElementById('forgotError');
            const suc = document.getElementById('forgotSuccess');
            hideMsg(err);
            
            if (!newP || !confP) { showMsg(err, 'âŒ Fill all fields'); return; }
            if (newP.length < 4) { showMsg(err, 'âŒ Min 4 chars'); return; }
            if (newP !== confP) { showMsg(err, 'âŒ Mismatch'); return; }
            
            const users = DB.get('users');
            users[forgotUserData.id].password = newP;
            DB.set('users', users);
            
            showMsg(suc, 'âœ… Password reset!', 'success');
            setTimeout(() => switchAuthTab('login'), 1500);
        }

        function logout() {
            currentUser = null;
            isAdmin = false;
            DB.set('currentUser', null);
            localStorage.removeItem('ntm_admin');
            updateUI();
        }

        // ============================================
        // ADMIN FUNCTIONS
        // ============================================
        function openAdminLogin() { openModal('adminLoginModal'); document.getElementById('adminPassword').value = ''; }

        function adminLogin() {
            if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
                isAdmin = true;
                localStorage.setItem('ntm_admin', 'true');
                closeModal('adminLoginModal');
                openAdminDashboard();
                updateUI();
            } else {
                showMsg(document.getElementById('adminLoginError'), 'âŒ Wrong password');
            }
        }

        function adminLogout() {
            isAdmin = false;
            localStorage.removeItem('ntm_admin');
            closeModal('adminDashboardModal');
            updateUI();
        }

        function openAdminDashboard() {
            renderUsersTable();
            renderAdminTables();
            updateStats();
            openModal('adminDashboardModal');
        }

        function showAdminPanel(id) {
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        function updateStats() {
            const users = Object.values(DB.get('users') || {});
            const updates = Object.values(DB.get('updates') || {});
            const cols = Object.values(DB.get('collections') || {});
            const exps = Object.values(DB.get('expenses') || {});
            const bal = cols.reduce((s, c) => s + (c.amount || 0), 0) - exps.reduce((s, e) => s + (e.amount || 0), 0);
            
            document.getElementById('statUsers').textContent = users.length;
            document.getElementById('statBlocked').textContent = users.filter(u => u.blocked).length;
            document.getElementById('statUpdates').textContent = updates.length;
            document.getElementById('statFunds').textContent = 'â‚¹' + bal.toLocaleString();
            document.getElementById('homeUserCount').textContent = users.length;
        }

        function blockUser(id) {
            if (!confirm('Block this user?')) return;
            const users = DB.get('users');
            users[id].blocked = true;
            DB.set('users', users);
            if (currentUser?.id === id) { currentUser.blocked = true; updateUI(); }
            renderUsersTable();
            updateStats();
        }

        function unblockUser(id) {
            if (!confirm('Unblock this user?')) return;
            const users = DB.get('users');
            users[id].blocked = false;
            DB.set('users', users);
            if (currentUser?.id === id) { currentUser.blocked = false; updateUI(); }
            renderUsersTable();
            updateStats();
        }

        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        function renderUsersTable() {
            const users = DB.get('users') || {};
            const entries = Object.entries(users);
            document.getElementById('usersTableBody').innerHTML = entries.length === 0 ? '<tr><td colspan="5" style="text-align:center;">No users</td></tr>' :
                entries.map(([id, u]) => `<tr><td>${u.name}</td><td>${u.email}</td><td>${u.mobile}</td><td><span class="user-status ${u.blocked ? 'blocked' : 'active'}">${u.blocked ? 'Blocked' : 'Active'}</span></td><td>${u.blocked ? `<button class="action-btn action-unblock" onclick="unblockUser('${id}')">Unblock</button>` : `<button class="action-btn action-block" onclick="blockUser('${id}')">Block</button>`}</td></tr>`).join('');
        }

        function renderInstitutions() {
            const data = DB.get('institutions') || {};
            document.getElementById('institutionsList').innerHTML = Object.values(data).map(i => `<div class="inst-item"><div class="inst-icon">${i.icon}</div><div class="inst-info"><h4>${i.name}</h4><p>ğŸ“ ${i.phone} | ğŸ• ${i.hours}</p></div><span class="inst-status">Open</span></div>`).join('');
        }

        function renderCollections() {
            const data = DB.get('collections') || {};
            const entries = Object.entries(data);
            document.getElementById('collectionsList').innerHTML = entries.length === 0 ? '<p style="color: var(--text-light); font-size: 0.85em;">No collections yet</p>' :
                entries.map(([id, c]) => `<div class="fund-item"><div class="fund-icon in">ğŸ’µ</div><div class="fund-details"><h4>${c.name} <span class="purpose-tag ${PURPOSE_TAGS[c.purpose]?.class || ''}">${PURPOSE_TAGS[c.purpose]?.label || c.purpose}</span></h4><p>ğŸ“… ${c.date || 'N/A'}</p></div><div class="fund-amount in">+â‚¹${(c.amount || 0).toLocaleString()}</div></div>`).join('');
            document.getElementById('colTableBody').innerHTML = entries.length === 0 ? '<tr><td colspan="4" style="text-align:center;">No data</td></tr>' :
                entries.map(([id, c]) => `<tr><td>${c.name}</td><td style="color:var(--primary);">â‚¹${(c.amount||0).toLocaleString()}</td><td>${PURPOSE_TAGS[c.purpose]?.label||c.purpose}</td><td><button class="action-btn action-delete" onclick="deleteCollection('${id}')">ğŸ—‘ï¸</button></td></tr>`).join('');
        }

        function renderExpenses() {
            const data = DB.get('expenses') || {};
            const entries = Object.entries(data);
            document.getElementById('expensesList').innerHTML = entries.length === 0 ? '<p style="color: var(--text-light); font-size: 0.85em;">No expenses yet</p>' :
                entries.map(([id, e]) => `<div class="fund-item expense"><div class="fund-icon out">ğŸ’¸</div><div class="fund-details"><h4>${e.description} <span class="purpose-tag ${PURPOSE_TAGS[e.category]?.class || ''}">${PURPOSE_TAGS[e.category]?.label || e.category}</span></h4><p>ğŸ“… ${e.date || 'N/A'}</p></div><div class="fund-amount out">-â‚¹${(e.amount || 0).toLocaleString()}</div></div>`).join('');
            document.getElementById('expTableBody').innerHTML = entries.length === 0 ? '<tr><td colspan="4" style="text-align:center;">No data</td></tr>' :
                entries.map(([id, e]) => `<tr><td>${e.description}</td><td style="color:var(--secondary);">â‚¹${(e.amount||0).toLocaleString()}</td><td>${PURPOSE_TAGS[e.category]?.label||e.category}</td><td><button class="action-btn action-delete" onclick="deleteExpense('${id}')">ğŸ—‘ï¸</button></td></tr>`).join('');
        }

        function updateFundSummary() {
            const cols = Object.values(DB.get('collections') || {});
            const exps = Object.values(DB.get('expenses') || {});
            const c = cols.reduce((s, x) => s + (x.amount || 0), 0);
            const e = exps.reduce((s, x) => s + (x.amount || 0), 0);
            document.getElementById('totalCollected').textContent = 'â‚¹' + c.toLocaleString();
            document.getElementById('totalSpent').textContent = 'â‚¹' + e.toLocaleString();
            document.getElementById('fundBalance').textContent = 'â‚¹' + (c - e).toLocaleString();
            document.getElementById('homeFundBalance').textContent = 'â‚¹' + (c - e).toLocaleString();
        }

        function renderUpdates() {
            const data = DB.get('updates') || {};
            const entries = Object.entries(data).sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));
            document.getElementById('updatesList').innerHTML = entries.length === 0 ? '<p style="color: var(--text-light); font-size: 0.85em;">No announcements yet</p>' :
                entries.map(([id, u]) => `<div class="update-item ${u.priority}"><div class="update-time">ğŸ“… ${u.date || 'N/A'}${u.priority !== 'normal' ? `<span class="priority-badge ${u.priority}">${u.priority.toUpperCase()}</span>` : ''}</div><div class="update-title">${u.title}</div><p style="font-size: 0.85em;">${u.details}</p></div>`).join('');
        }

        function renderEvents() {
            const data = DB.get('events') || {};
            const entries = Object.entries(data).sort((a, b) => new Date(a[1].date) - new Date(b[1].date));
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            document.getElementById('eventsList').innerHTML = entries.length === 0 ? '<p style="color: var(--text-light); font-size: 0.85em;">No upcoming events</p>' :
                entries.map(([id, e]) => { const d = new Date(e.date); return `<div class="event-item"><div class="event-date"><div class="day">${d.getDate()}</div><div class="month">${months[d.getMonth()]}</div></div><div class="event-details"><h4>${e.title}</h4><p>ğŸ“ ${e.location || 'TBD'}</p></div></div>`; }).join('');
        }

        function renderJobs() {
            const data = DB.get('jobs') || {};
            const entries = Object.entries(data);
            document.getElementById('jobsList').innerHTML = entries.length === 0 ? '<p style="color: var(--text-light); font-size: 0.85em;">No job notices</p>' :
                entries.map(([id, j]) => `<div class="job-item"><h4>${j.title}</h4><div class="job-meta"><span>ğŸ¢ ${j.org}</span><span>ğŸ‘¥ ${j.vacancies || 'Various'}</span><span>ğŸ“… ${j.lastDate}</span></div><div class="job-actions"><a href="${j.link}" target="_blank" class="btn btn-primary" style="font-size: 0.8em;">ğŸ“ Apply</a></div></div>`).join('');
        }

        function renderChat() {
            const data = DB.get('messages') || {};
            const entries = Object.entries(data).sort((a, b) => (a[1].timestamp || 0) - (b[1].timestamp || 0));
            document.getElementById('chatMessages').innerHTML = entries.map(([id, m]) => {
                const own = currentUser && m.oderId === currentUser.id;
                return `<div class="message ${own ? 'own' : ''}"><div class="msg-avatar">${(m.sender || 'U').charAt(0).toUpperCase()}</div><div class="msg-content"><div class="msg-sender">${m.sender || 'Unknown'}</div><div class="msg-bubble">${m.message}</div><div class="msg-time">${m.time || ''}</div></div></div>`;
            }).join('');
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function renderAdminTables() {
            const updates = DB.get('updates') || {};
            document.getElementById('annTableBody').innerHTML = Object.entries(updates).length === 0 ? '<tr><td colspan="4" style="text-align:center;">No data</td></tr>' :
                Object.entries(updates).map(([id, u]) => `<tr><td>${u.title}</td><td><span class="priority-badge ${u.priority}" style="color:white;">${u.priority}</span></td><td>${u.date||'N/A'}</td><td><button class="action-btn action-delete" onclick="deleteUpdate('${id}')">ğŸ—‘ï¸</button></td></tr>`).join('');
            
            const events = DB.get('events') || {};
            document.getElementById('evtTableBody').innerHTML = Object.entries(events).length === 0 ? '<tr><td colspan="4" style="text-align:center;">No data</td></tr>' :
                Object.entries(events).map(([id, e]) => `<tr><td>${e.title}</td><td>${e.date}</td><td>${e.location||'TBD'}</td><td><button class="action-btn action-delete" onclick="deleteEvent('${id}')">ğŸ—‘ï¸</button></td></tr>`).join('');
            
            const jobs = DB.get('jobs') || {};
            document.getElementById('jobTableBody').innerHTML = Object.entries(jobs).length === 0 ? '<tr><td colspan="4" style="text-align:center;">No data</td></tr>' :
                Object.entries(jobs).map(([id, j]) => `<tr><td>${j.title}</td><td>${j.org}</td><td>${j.lastDate}</td><td><button class="action-btn action-delete" onclick="deleteJob('${id}')">ğŸ—‘ï¸</button></td></tr>`).join('');
        }

        // ============================================
        // ADMIN ACTIONS
        // ============================================
        function postAnnouncement() {
            const t = document.getElementById('annTitle').value.trim();
            const d = document.getElementById('annDetails').value.trim();
            const p = document.getElementById('annPriority').value;
            if (!t || !d) { alert('Fill all fields'); return; }
            const data = DB.get('updates') || {};
            data['upd' + Date.now()] = { title: t, details: d, priority: p, date: new Date().toLocaleDateString(), timestamp: Date.now() };
            DB.set('updates', data);
            document.getElementById('annTitle').value = '';
            document.getElementById('annDetails').value = '';
            renderUpdates(); renderAdminTables(); updateStats();
            alert('âœ… Posted!');
        }

        function deleteUpdate(id) { if (!confirm('Delete?')) return; const d = DB.get('updates') || {}; delete d[id]; DB.set('updates', d); renderUpdates(); renderAdminTables(); updateStats(); }

        function addCollection() {
            const n = document.getElementById('colName').value.trim();
            const a = parseInt(document.getElementById('colAmount').value);
            const p = document.getElementById('colPurpose').value;
            if (!n || !a) { alert('Fill required fields'); return; }
            const d = DB.get('collections') || {};
            d['col' + Date.now()] = { name: n, amount: a, purpose: p, date: new Date().toLocaleDateString(), timestamp: Date.now() };
            DB.set('collections', d);
            document.getElementById('colName').value = '';
            document.getElementById('colAmount').value = '';
            renderCollections(); updateFundSummary(); updateStats();
            alert('âœ… Added!');
        }

        function deleteCollection(id) { if (!confirm('Delete?')) return; const d = DB.get('collections') || {}; delete d[id]; DB.set('collections', d); renderCollections(); updateFundSummary(); updateStats(); }

        function addExpense() {
            const desc = document.getElementById('expDesc').value.trim();
            const a = parseInt(document.getElementById('expAmount').value);
            const c = document.getElementById('expCategory').value;
            if (!desc || !a) { alert('Fill required fields'); return; }
            const d = DB.get('expenses') || {};
            d['exp' + Date.now()] = { description: desc, amount: a, category: c, date: new Date().toLocaleDateString(), timestamp: Date.now() };
            DB.set('expenses', d);
            document.getElementById('expDesc').value = '';
            document.getElementById('expAmount').value = '';
            renderExpenses(); updateFundSummary(); updateStats();
            alert('âœ… Added!');
        }

        function deleteExpense(id) { if (!confirm('Delete?')) return; const d = DB.get('expenses') || {}; delete d[id]; DB.set('expenses', d); renderExpenses(); updateFundSummary(); updateStats(); }

        function addEvent() {
            const t = document.getElementById('evtTitle').value.trim();
            const dt = document.getElementById('evtDate').value;
            const l = document.getElementById('evtLocation').value.trim();
            if (!t || !dt) { alert('Fill required fields'); return; }
            const d = DB.get('events') || {};
            d['evt' + Date.now()] = { title: t, date: dt, location: l || 'TBD', timestamp: Date.now() };
            DB.set('events', d);
            document.getElementById('evtTitle').value = '';
            document.getElementById('evtDate').value = '';
            document.getElementById('evtLocation').value = '';
            renderEvents(); renderAdminTables();
            alert('âœ… Added!');
        }

        function deleteEvent(id) { if (!confirm('Delete?')) return; const d = DB.get('events') || {}; delete d[id]; DB.set('events', d); renderEvents(); renderAdminTables(); }

        function addJob() {
            const t = document.getElementById('jobTitle').value.trim();
            const o = document.getElementById('jobOrg').value.trim();
            const v = document.getElementById('jobVacancies').value;
            const dt = document.getElementById('jobLastDate').value;
            const l = document.getElementById('jobLink').value.trim();
            if (!t || !o || !dt || !l) { alert('Fill required fields'); return; }
            const d = DB.get('jobs') || {};
            d['job' + Date.now()] = { title: t, org: o, vacancies: v || 'Various', lastDate: dt, link: l, timestamp: Date.now() };
            DB.set('jobs', d);
            ['jobTitle', 'jobOrg', 'jobVacancies', 'jobLastDate', 'jobLink'].forEach(i => document.getElementById(i).value = '');
            renderJobs(); renderAdminTables();
            alert('âœ… Added!');
        }

        function deleteJob(id) { if (!confirm('Delete?')) return; const d = DB.get('jobs') || {}; delete d[id]; DB.set('jobs', d); renderJobs(); renderAdminTables(); }

        // ============================================
        // CHAT
        // ============================================
        function sendMessage() {
            if (!currentUser) { alert('Please login'); return; }
            if (currentUser.blocked) { alert('Account blocked'); return; }
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            const d = DB.get('messages') || {};
            d['msg' + Date.now()] = { oderId: currentUser.id, sender: currentUser.name, message: msg, time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }), timestamp: Date.now() };
            DB.set('messages', d);
            input.value = '';
            renderChat();
        }
    </script>
</body>
</html>